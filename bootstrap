#! /usr/bin/env bash
set -e

function git_sync() {
  local repo="$1"
  local dir="$2"
  if [[ -d $dir ]]; then
    (cd $dir && git pull)
  else
    mkdir -p $dir
    git clone $repo $dir
  fi
}

function install_brew() {
  which brew &> /dev/null || ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)"
  source ./brewfile
  local brew_bash="$(brew --prefix)/bin/bash"
  if ! grep -q $brew_bash /etc/shells; then
    sudo bash -c "echo $brew_bash >> /etc/shells"
  fi
  if ! which bash | grep -q $brew_bash; then
    sudo chsh -s "$brew_bash" $USER
  fi
}

function install_rbenv() {
  local rbenv_root=$HOME/.rbenv
  git_sync "git@github.com:sstephenson/rbenv/" $rbenv_root
  local rbenv_plugins=$rbenv_root/plugins
  git_sync "git@github.com:sstephenson/ruby-build/" $rbenv_plugins/ruby-build
  git_sync "git@github.com:sstephenson/rbenv-gem-rehash/" $rbenv_plugins/rbenv-gem-rehash
}

function install_ruby() {
  bash -c "
    source $HOME/.bash_profile
    rbenv install $1 --keep --verbose --skip-existing
    rbenv global $1
    if ! gem list interactive_editor | grep -q interactive_editor; then
      gem install interactive_editor
    fi
    if ! gem list bundler | grep -q bundler; then
      gem install bundler
    fi
    gem update --system
    gem update
    gem cleanup
  "
}

function setup_vim() {
  mkdir -p $HOME/.vim
  git_sync "git@github.com:gmarik/Vundle.vim.git" $HOME/.vim/bundle/Vundle.vim
  (vim +PluginUpdate +qall &> /dev/null) &
}

mkdir -p $HOME/bin
find $PWD -name '.[^.DS_Store]*' -type f -depth 1 | xargs -I % ln -sfv % $HOME
ln -sfv $PWD/.cabal/* $HOME/.cabal

setup_vim

if [[ -z "$NOBREW" ]]; then
  install_brew
fi

if [[ -z "$NORBENV" ]]; then
  install_rbenv
  install_ruby "2.1.5"
  install_ruby "2.2.0"
fi

echo 'Bootstrap complete'
